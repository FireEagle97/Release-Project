import { React, useState } from 'react';
import './post_listing.css';
import PlacesAutocomplete, { geocodeByAddress, getLatLng } from 'react-places-autocomplete';


export default function PostListing() {
  const [rentPrice, setRentPrice] = useState('');
  const [address, setAddress] = useState('');
  const [city, setCity] = useState('');
  const [description, setDescription] = useState('');
  const [contactInfo, setContactInfo] = useState('');
  const [size, setSize] = useState('');
  const [bedrooms, setBedrooms] = useState('');
  const [bathrooms, setBathrooms] = useState('');
  const [floorNumber, setFloorNumber] = useState('');
  const [furnishing, setFurnishing] = useState('');
  const [preferredTentant, setpreferredTentant] = useState('');
  const [files, setFiles] = useState([]);
  const [addressSuggestions, setAddressSuggestions] = useState([]);

  const handleChange = (event) => {
    const { name, value } = event.target;

    switch (name) {
      case 'city':
        setCity(value);
        break;
      case 'rentPrice':
        setRentPrice(value);
        break;
      case 'address':
        setAddress(value);
        break;
      case 'description':
        setDescription(value);
        break;
      case 'contactInfo':
        setContactInfo(value);
        break;
      case 'size':
        setSize(value);
        break;
      case 'bedrooms':
        setBedrooms(value);
        break;
      case 'bathrooms':
        setBathrooms(value);
        break;
      case 'floorNumber':
        setFloorNumber(value);
        break;
      case 'furnishing':
        setFurnishing(value);
        break;
      case 'preferredTentant':
        setpreferredTentant(value);
      break;
      case 'images':
        setFiles((prevFiles) => [...prevFiles, ...Array.from(event.target.files)]);
        break;
      default:
        break;
    }
  };

  const handleRemoveImage = (index) => {
    const updatedFiles = [...files];
    updatedFiles.splice(index, 1);
    setFiles(updatedFiles);
  };

  const isFormValid = () => {

    const validTextFields = [city, address, description, contactInfo, preferredTentant].every((field) => field.trim() !== '')
    const validNumFields = [rentPrice, size, bedrooms, bathrooms, floorNumber].every((field) => field.length > 0);
    const validFurnishing = ['Unfurnished', 'Semi-Furnished', 'Furnished'].includes(furnishing);


    return validTextFields && validNumFields && validFurnishing;
  };

  const handleSubmit = async (event) => {
    event.preventDefault();

    const formData = new FormData();
    formData.append('city', city);
    formData.append('rentPrice', rentPrice);
    formData.append('address', address);
    formData.append('description', description);
    formData.append('contactInfo', contactInfo);
    formData.append('size', size);
    formData.append('bedrooms', bedrooms);
    formData.append('bathrooms', bathrooms);
    formData.append('floorNumber', floorNumber);
    formData.append('furnishing', furnishing);
    formData.append('preferredTentant', preferredTentant);
    files.forEach((file, index) => {
      formData.append(`file${index + 1}`, file);
    });

    //formdata
    for (const pair of formData.entries()) {
      console.log(`${pair[0]}: ${pair[1]}`);
    }

    try {
      await fetch('/leaseUpload', {
        method: 'POST',
        headers: {},
        body: formData,
      });

      alert('Submitted successfully');
      resetForm();
    } catch (error) {
      console.error('Error:', error);
      alert('Error submitting the form');
    }
  };

  const resetForm = () => {
    setCity('');
    setRentPrice('');
    setAddress('');
    setDescription('');
    setContactInfo('');
    setSize('');
    setBedrooms('');
    setBathrooms('');
    setFloorNumber('');
    setFurnishing('');
    setpreferredTentant('');
    setFiles([]);
  };

  /** address pick */
  const handleAddressChange = address => {
    setAddress(address);
  };

  const handleSelect = async (address) => {
    setAddress(address);
    setAddressSuggestions([]);
    try {
      const results = await geocodeByAddress(address);
      const latLng = await getLatLng(results[0]);
      console.log('Latlng:', latLng); // You can use latLng for further processing
    } catch (error) {
      console.error('Error selecting address:', error);
    }
  };

  const handleFetchSuggestions = async (value) => {
    try {
      const results = await geocodeByAddress(value);
      if(results){
        setAddressSuggestions(results.map((result) => result.formatted_address));
      }
    } catch (error) {
      console.error('Error fetching suggestions:', error);
    }
  };

  const handleBlur = () => {
    setAddressSuggestions([]);
  };

  return (
    <div className="post-listing-container">
      <h1 className="create-listing">Create Your Listing</h1>
      <form onSubmit={handleSubmit}>
        <div className="float-container">
        <div className="float-child">

          <label htmlFor="rentPrice">Rent Price</label>
          <input type="number" id="rentPrice" name="rentPrice" value={rentPrice} onChange={handleChange} min="0" />

          <label htmlFor="address">Address</label>
          <label htmlFor="address">Address</label>
            <PlacesAutocomplete
              value={address}
              onChange={handleAddressChange}
              onSelect={handleSelect}
              onBlur={handleBlur}
              searchOptions={{ types: ['geocode'] }}
              debounce={300}
            >
              {({ getInputProps, addressSuggestions, getSuggestionItemProps, loading }) => (
                <div>
                  <input
                    {...getInputProps({
                      placeholder: 'Enter address...',
                      className: 'location-search-input',
                    })}
                  />
                  <div className="autocomplete-dropdown-container">
                    {loading && <div>Loading...</div>}
                    {addressSuggestions.map((suggestion, index) => {
                      const className = suggestion.active
                        ? 'suggestion-item--active'
                        : 'suggestion-item';
                      return (
                        <div
                          key={index}
                          {...getSuggestionItemProps(suggestion, {
                            className,
                          })}
                        >
                          <span>{suggestion.description}</span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </PlacesAutocomplete>
          <input type="text" id="address" name="address" value={address} onChange={handleChange} />

          <label htmlFor="city">City</label>
          <input type="text" id="city" name="city" value={city} onChange={handleChange} />

          <label htmlFor="size">Size (sq ft)</label>
          <input type="number" id="size" name="size" value={size} onChange={handleChange} />

          <label htmlFor="bedrooms">Number of Bedrooms</label>
          <input type="number" id="bedrooms" name="bedrooms" value={bedrooms} onChange={handleChange} min="0" />

          <label htmlFor="bathrooms">Number of Bathrooms</label>
          <input type="number" id="bathrooms" name="bathrooms" value={bathrooms} onChange={handleChange} min="0" />

          <label htmlFor="floorNumber">Floor Number</label>
          <input type="number" id="floorNumber" name="floorNumber" value={floorNumber} onChange={handleChange} min="0" />

          <label htmlFor="furnishing">Furnishing</label>
          <br></br>

          <div className="furnishing-options">
            <label>
              <input type="radio" id="unfurnished" name="furnishing" value="Unfurnished" checked={furnishing === 'Unfurnished'} onChange={handleChange}/>
              <span className="radio-circle"></span> Unfurnished
            </label>

            <label>
              <input
                type="radio" id="semiFurnished" name="furnishing" value="Semi-Furnished" checked={furnishing === 'Semi-Furnished'} onChange={handleChange}/>
              <span className="radio-circle"></span> Semi-Furnished
            </label>

            <label>
              <input
                type="radio" id="furnished" name="furnishing" value="Furnished" checked={furnishing === 'Furnished'} onChange={handleChange}/>
              <span className="radio-circle"></span> Furnished
            </label>
          </div>

          <br></br>

          <label htmlFor="preferredTentant">Preffered Tenants</label>
          <input type="text" id="preferredTentant" name="preferredTentant" value={preferredTentant} onChange={handleChange} />

          <label htmlFor="description">Description</label>
          <textarea id="description" name="description" value={description} onChange={handleChange} />

          <label htmlFor="contactInfo">Contact Information</label>
          <input type="text" id="contactInfo" name="contactInfo" value={contactInfo} onChange={handleChange} />
        </div>

        <div className="float-child">
          <div className="image-column">
            <label htmlFor="images">Add images</label>
            <input type="file" id="images" name="images" onChange={handleChange} multiple />
            
            <div className="image-preview">
              {files.map((file, index) => (
                
                <div key={index} className="image-container">
                  <img alt="Preview" src={URL.createObjectURL(file)} />
                  <button type="button" onClick={() => handleRemoveImage(index)}>
                    x
                  </button>
                </div>
              ))}
            </div>

          </div>
          </div>
        </div>

        <button type="submit" disabled={!isFormValid()}>Submit</button>
      </form>
    </div>
  );
}


/** address api
 * 
 * https://serpapi.com/search?engine=google_maps
 * https://serpapi.com/google-maps-api
 * 
 * https://developers.google.com/maps/documentation/geocoding/overview
 * https://maps.googleapis.com/maps/api/geocode/outputFormat?parameters
 * 
 * https://developers.google.com/maps/documentation/javascript/place-autocomplete
 */